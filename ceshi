#!/bin/bash

# ==============================================================================
# 脚本名称: Debian 11 VPS 初始化全能脚本 (增强版)
# 功能: 时区 / SSH端口修改 / 公钥 / UFW / Fail2Ban / BBR / Swap / 日志权限
# ==============================================================================

# 颜色定义
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# 默认配置
DEFAULT_SSH_KEY="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINvyH3RGNA/b9OuBLnHIpzmFIOQuWSpSt2bdgyPjoujE admin@gmail.com"
DEFAULT_TIMEZONE="Asia/Shanghai"

echo -e "${GREEN}=== 开始执行 Debian 11 初始化配置 (增强版) ===${NC}"

# 1. 权限检查
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}错误: 请使用 root 权限运行此脚本!${NC}"
  exit 1
fi

# 2. 更新系统与安装依赖
echo -e "${YELLOW}>> [1/9] 更新系统与安装依赖...${NC}"
export DEBIAN_FRONTEND=noninteractive
apt update -y && apt upgrade -y
apt install -y curl wget git vim ufw fail2ban chrony rsyslog net-tools dnsutils

# =======================================================
# 3. 时区设置 (新增)
# =======================================================
echo -e "${YELLOW}>> [2/9] 配置系统时区...${NC}"
read -p "请输入时区 (回车默认 Asia/Shanghai): " INPUT_TZ
FINAL_TZ=${INPUT_TZ:-$DEFAULT_TIMEZONE}

if [ -f "/usr/share/zoneinfo/$FINAL_TZ" ]; then
    ln -sf "/usr/share/zoneinfo/$FINAL_TZ" /etc/localtime
    echo "$FINAL_TZ" > /etc/timezone
    echo -e "${GREEN}时区已设置为: $FINAL_TZ (当前时间: $(date))${NC}"
else
    echo -e "${RED}错误: 时区 $FINAL_TZ 不存在，保持原样。${NC}"
fi

# =======================================================
# 4. 日志环境初始化
# =======================================================
echo -e "${YELLOW}>> [3/9] 初始化系统日志环境...${NC}"
systemctl enable --now rsyslog
sleep 2
LOG_FILE="/var/log/auth.log"
if [ ! -f "$LOG_FILE" ]; then
    touch "$LOG_FILE"
fi
chmod 640 "$LOG_FILE"
chown root:adm "$LOG_FILE"
systemctl restart rsyslog
echo -e "${GREEN}日志权限已修正。${NC}"

# =======================================================
# 5. SSH 配置 (含端口修改与公钥覆盖)
# =======================================================
echo -e "${YELLOW}>> [4/9] 配置 SSH 服务...${NC}"

# --- 5.1 修改 SSH 端口 (新增) ---
CURRENT_PORT=$(grep "^Port" /etc/ssh/sshd_config | awk '{print $2}' | head -n 1)
[ -z "$CURRENT_PORT" ] && CURRENT_PORT=22

echo -e "${CYAN}当前 SSH 端口为: $CURRENT_PORT${NC}"
read -p "请输入新的 SSH 端口 (回车保留 $CURRENT_PORT): " INPUT_PORT
SSH_PORT=${INPUT_PORT:-$CURRENT_PORT}

# 简单验证端口范围
if ! [[ "$SSH_PORT" =~ ^[0-9]+$ ]] || [ "$SSH_PORT" -lt 1 ] || [ "$SSH_PORT" -gt 65535 ]; then
    echo -e "${RED}错误: 端口必须是 1-65535 之间的数字。${NC}"
    exit 1
fi

# --- 5.2 公钥配置 ---
echo -e "${CYAN}请设置 SSH 登录公钥 (将覆盖旧公钥):${NC}"
read -p "请输入公钥 (直接回车使用内置默认): " INPUT_SSH_KEY
FINAL_SSH_KEY=${INPUT_SSH_KEY:-$DEFAULT_SSH_KEY}

if [[ ${#FINAL_SSH_KEY} -lt 20 ]]; then
    echo -e "${RED}错误: 公钥长度过短，停止脚本。${NC}"
    exit 1
fi

mkdir -p /root/.ssh
chmod 700 /root/.ssh
echo "$FINAL_SSH_KEY" > /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys
echo -e "${GREEN}SSH 公钥已重置。${NC}"

# --- 5.3 修改配置文件 ---
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak.$(date +%F_%T)

update_sshd_config() {
    local param=$1
    local value=$2
    local file="/etc/ssh/sshd_config"
    if grep -q "^#\?${param}" "$file"; then
        sed -i "s/^#\?${param}.*/${param} ${value}/" "$file"
    else
        echo "${param} ${value}" >> "$file"
    fi
}

echo -e "正在更新 SSH 配置文件..."
update_sshd_config "Port" "$SSH_PORT"                     # 修改端口
update_sshd_config "PasswordAuthentication" "no"          # 禁止密码
update_sshd_config "PermitEmptyPasswords" "no"            # 禁止空密码
update_sshd_config "ChallengeResponseAuthentication" "no" # 禁用挑战响应
update_sshd_config "PubkeyAuthentication" "yes"           # 启用公钥
update_sshd_config "UseDNS" "no"                          # 禁用 DNS 反查
update_sshd_config "PermitRootLogin" "prohibit-password"  # 允许Root密钥登录

echo -e "${GREEN}SSH 配置已更新 (端口: $SSH_PORT)。服务将在脚本最后重启。${NC}"

# =======================================================
# 6. NTP 时间同步
# =======================================================
echo -e "${YELLOW}>> [5/9] 配置 NTP 时间同步...${NC}"
[ -f /etc/chrony/chrony.conf ] && cp /etc/chrony/chrony.conf /etc/chrony/chrony.conf.bak 2>/dev/null
sed -i '/^pool/d' /etc/chrony/chrony.conf
sed -i '/^server/d' /etc/chrony/chrony.conf
if ! grep -q "time.cloudflare.com" /etc/chrony/chrony.conf; then
    sed -i '1i server time.cloudflare.com iburst minpoll 4 maxpoll 4' /etc/chrony/chrony.conf
fi
systemctl restart chrony
systemctl enable chrony
chronyc makestep > /dev/null 2>&1
echo -e "${GREEN}Chrony 已配置。${NC}"

# =======================================================
# 7. UFW 防火墙 (适配新端口)
# =======================================================
echo -e "${YELLOW}>> [6/9] 配置 UFW 防火墙...${NC}"

echo -e "${CYAN}即将放行新的 SSH 端口: $SSH_PORT${NC}"
read -p "是否放行 Web 端口 (80/443)? (y/n, 默认 y): " OPEN_WEB
OPEN_WEB=${OPEN_WEB:-y}
read -p "请输入其他需放行端口 (空格分隔): " OTHER_PORTS

ufw --force reset > /dev/null
ufw default deny incoming
ufw default allow outgoing

# 放行刚才设置的新 SSH 端口
ufw allow "$SSH_PORT"/tcp comment 'SSH Port'

if [[ "$OPEN_WEB" =~ ^[Yy] ]]; then
    ufw allow 80/tcp comment 'HTTP'
    ufw allow 443/tcp comment 'HTTPS'
fi

if [ -n "$OTHER_PORTS" ]; then
    for port in $OTHER_PORTS; do
        ufw allow "$port"/tcp
    done
fi

echo "y" | ufw enable
systemctl enable ufw
echo -e "${GREEN}UFW 已启用并放行端口 $SSH_PORT。${NC}"

# =======================================================
# 8. Fail2Ban (适配新端口)
# =======================================================
echo -e "${YELLOW}>> [7/9] 配置 Fail2Ban...${NC}"

read -p "最大重试次数 (默认 3): " F2B_RETRY
F2B_RETRY=${F2B_RETRY:-3}
read -p "封禁小时数 (-1为永久, 默认 24): " F2B_HOURS
F2B_HOURS=${F2B_HOURS:-24}

if [ "$F2B_HOURS" == "-1" ]; then
    F2B_BANTIME=-1
else
    F2B_BANTIME=$(($F2B_HOURS * 3600))
fi

cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local 2>/dev/null

# 写入配置，使用刚才设置的 SSH_PORT
cat <<EOF > /etc/fail2ban/jail.d/sshd_custom.conf
[sshd]
enabled = true
port    = $SSH_PORT
filter  = sshd
logpath = /var/log/auth.log
backend = polling
banaction = ufw
maxretry = $F2B_RETRY
findtime = 600
bantime  = $F2B_BANTIME
EOF

systemctl enable fail2ban
systemctl restart fail2ban
echo -e "${GREEN}Fail2Ban 已启动 (保护端口: $SSH_PORT)。${NC}"

# =======================================================
# 9. SWAP 虚拟内存设置 (新增)
# =======================================================
echo -e "${YELLOW}>> [8/9] 配置 SWAP 虚拟内存...${NC}"
read -p "是否添加/配置虚拟内存 SWAP? (y/n, 默认 n): " ENABLE_SWAP
if [[ "$ENABLE_SWAP" =~ ^[Yy] ]]; then
    read -p "请输入 Swap 大小 (单位 MB), 推荐 1024 或 2048: " SWAP_SIZE
    if [[ "$SWAP_SIZE" =~ ^[0-9]+$ ]]; then
        # 清理旧 swap
        swapoff -a
        sed -i '/swap/d' /etc/fstab
        rm -f /swapfile

        # 创建新 swap
        fallocate -l "${SWAP_SIZE}M" /swapfile
        chmod 600 /swapfile
        mkswap /swapfile
        swapon /swapfile
        echo "/swapfile none swap sw 0 0" >> /etc/fstab
        
        # 优化 swap 参数
        if ! grep -q "vm.swappiness" /etc/sysctl.conf; then
            echo "vm.swappiness=10" >> /etc/sysctl.conf
            echo "vm.vfs_cache_pressure=50" >> /etc/sysctl.conf
        fi
        sysctl -p > /dev/null
        echo -e "${GREEN}SWAP 创建成功: ${SWAP_SIZE}MB${NC}"
    else
        echo -e "${RED}输入无效，跳过 SWAP 设置。${NC}"
    fi
else
    echo -e "跳过 SWAP 设置。"
fi

# =======================================================
# 10. BBR 与 最终重启
# =======================================================
echo -e "${YELLOW}>> [9/9] 开启 BBR 并重启服务...${NC}"

if ! grep -q "net.core.default_qdisc=fq" /etc/sysctl.conf; then
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
fi
if ! grep -q "net.ipv4.tcp_congestion_control=bbr" /etc/sysctl.conf; then
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
fi
sysctl -p > /dev/null
echo -e "${GREEN}BBR 已启用。${NC}"

# 最后重启 SSHD，应用端口更改
systemctl restart sshd

echo -e "${GREEN}==============================================${NC}"
echo -e "${GREEN}           Debian 11 初始化配置完成           ${NC}"
echo -e "${GREEN}==============================================${NC}"
echo -e "1. SSH 端口: ${RED}$SSH_PORT${NC} (请注意更新连接信息!)"
echo -e "2. SSH 公钥: 已覆盖更新"
echo -e "3. 系统时区: $FINAL_TZ"
echo -e "4. 虚拟内存: $(free -h | grep Swap | awk '{print $2}')"
echo -e "5. 防火墙:   UFW 已启动 (Port $SSH_PORT Allowed)"
echo -e "6. Fail2Ban: Polling模式已启动"
echo -e ""
echo -e "${YELLOW}重要: 请不要关闭当前窗口!${NC}"
echo -e "${YELLOW}请新开一个终端，使用端口 $SSH_PORT 和新的私钥测试连接！${NC}"
